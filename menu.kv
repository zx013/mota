#:import EventLoop kivy.base.EventLoop
#:import FadeTransition kivy.uix.screenmanager.FadeTransition
#:import Store setting.Store
#:import Setting setting.Setting
#:import Mota mota.Mota

<MenuLabel>:
    #简化后的参数
    idx: 0
    idy: 0
    text: ''
    fsize: 4

    #调节配置中的size时不影响菜单
    ssize: Setting.size

    #根据地图大小动态变化的大小和位置
    length: sum([1 if c.isalpha() else 0.5 for c in self.text])
    pos_hint: {'center_x': self.idx * self.ssize * Setting.multiple / self.parent.width + 0.5, 'center_y': self.idy * self.ssize * Setting.multiple / self.parent.height + 0.5} if self.parent else {}
    size: (self.length * self.font_size * Setting.multiple, self.font_size * Setting.multiple)
    size_hint: (None, None)

    #字体
    font_size: self.fsize * self.ssize * Setting.multiple
    font_name: Setting.font_path

    #是否被选中，初始化状态
    selected: False
    state: 'down' if self.selected else 'normal'

    #选中后的颜色配置
    disabled_color: (1, 1, 1, 1)
    select_color: (1, 1, 0, 1)
    default_color: (1, 1, 1, 1)
    color: self.select_color if self.state == 'down' else self.default_color


<MenuParameter>:
    idx: 0
    idy: 0
    text: ''
    attr: 'title'
    min: 0
    max: 100
    MenuLabel:
        idx: self.parent.idx
        idy: self.parent.idy
        text: self.parent.text
        fsize: 3
        disabled: True
    MenuLabel:
        id: base
        idx: self.parent.idx + 6
        idy: self.parent.idy
        text: str(getattr(Setting, self.parent.attr))
        fsize: 3
        disabled: True
    MenuLabel:
        idx: self.parent.idx + 10
        idy: self.parent.idy
        text: '+'
        fsize: 3
        on_touch_up:
            self.state = 'normal'
        on_release:
            attr = getattr(Setting, self.parent.attr)
            attr += attr < self.parent.max
            setattr(Setting, self.parent.attr, attr)
            base.text = str(attr)
    MenuLabel:
        idx: self.parent.idx + 14
        idy: self.parent.idy
        text: '-'
        fsize: 3
        on_touch_up:
            self.state = 'normal'
        on_release:
            attr = getattr(Setting, self.parent.attr)
            attr -= attr > self.parent.min
            setattr(Setting, self.parent.attr, attr)
            base.text = str(attr)


<MenuSetting>:
    idx: 0
    idy: 0
    type: ''
    MenuLabel:
        idx: self.parent.idx
        idy: self.parent.idy
        text: '基本'
        fsize: 4
        color: self.select_color if self.parent.type == 'base' else self.default_color
        on_touch_up:
            self.state = 'normal'
        on_release:
            Store.save()
            self.parent.root.current = 'setting-base'
    MenuLabel:
        idx: self.parent.idx + 5
        idy: self.parent.idy
        text: '|'
        fsize: 6
        disabled: True
    MenuLabel:
        idx: self.parent.idx + 10
        idy: self.parent.idy
        text: '操作'
        fsize: 4
        color: self.select_color if self.parent.type == 'operate' else self.default_color
        on_touch_up:
            self.state = 'normal'
        on_release:
            Store.save()
            self.parent.root.current = 'setting-operate'
    MenuLabel:
        idx: self.parent.idx + 15
        idy: self.parent.idy
        text: '|'
        fsize: 6
        disabled: True
    MenuLabel:
        idx: self.parent.idx + 20
        idy: self.parent.idy
        text: '声音'
        fsize: 4
        color: self.select_color if self.parent.type == 'sound' else self.default_color
        on_touch_up:
            self.state = 'normal'
        on_release:
            Store.save()
            self.parent.root.current = 'setting-sound'
    MenuLabel:
        idx: self.parent.idx + 25
        idy: self.parent.idy
        text: '|'
        fsize: 6
        disabled: True
    MenuLabel:
        idx: self.parent.idx + 30
        idy: self.parent.idy
        text: '其它'
        fsize: 4
        color: self.select_color if self.parent.type == 'other' else self.default_color
        on_touch_up:
            self.state = 'normal'
        on_release:
            Store.save()
            self.parent.root.current = 'setting-other'
    MenuLabel:
        idx: 0
        idy: -15
        text: '返回'
        fsize: 3
        on_touch_up:
            self.state = 'normal'
        on_release:
            Store.save()
            self.parent.root.current = 'main'


<MenuManager>:
    transition: FadeTransition()
    size: (Setting.row_size, Setting.col_size)
    size_hint: (None, None)

    Screen:
        name: 'main'
        step: Setting.title_width / (len(Setting.title) - 1)
        title_x: [- Setting.title_width / 2 + n * self.step for n, c in enumerate(Setting.title)]
        title_y: [7 + (Setting.title_radius ** 2 - x ** 2) ** 0.5 - (Setting.title_radius ** 2 - 14 ** 2) ** 0.5 for x in self.title_x]

        MenuLabel:
            idx: self.parent.title_x[0]
            idy: self.parent.title_y[0]
            text: Setting.title[0]
            fsize: 8
            disabled: True
        MenuLabel:
            idx: self.parent.title_x[1]
            idy: self.parent.title_y[1]
            text: Setting.title[1]
            fsize: 8
            disabled: True
        MenuLabel:
            idx: self.parent.title_x[2]
            idy: self.parent.title_y[2]
            text: Setting.title[2]
            fsize: 8
            disabled: True
        MenuLabel:
            idx: self.parent.title_x[3]
            idy: self.parent.title_y[3]
            text: Setting.title[3]
            fsize: 8
            disabled: True
        MenuLabel:
            idx: self.parent.title_x[4]
            idy: self.parent.title_y[4]
            text: Setting.title[4]
            fsize: 8
            disabled: True
        MenuLabel:
            idx: 0
            idy: 6
            text: ' '.join([c for c in Setting.version])
            fsize: 4
            disabled: True
        MenuLabel:
            idx: 0
            idy: 0
            text: '开 始'
            fsize: 6
            on_touch_up:
                self.state = 'normal'
            on_release:
                root.current = 'start'
        MenuLabel:
            idx: 0
            idy: -7
            text: '设 置'
            fsize: 6
            on_touch_up:
                self.state = 'normal'
            on_release:
                root.current = 'setting-base'
        MenuLabel:
            idx: 0
            idy: -13
            text: '退 出'
            fsize: 4
            on_touch_up:
                self.state = 'normal'
            on_release:
                EventLoop.exit()

    Screen:
        name: 'start'

        MenuLabel:
            idx: 0
            idy: 5
            text: '开 始'
            fsize: 4
            on_touch_up:
                self.state = 'normal'
            on_release:
                root.current = 'mota'
        MenuLabel:
            idx: 0
            idy: 0
            text: '继 续'
            fsize: 4
            disabled: True
            on_touch_up:
                self.state = 'normal'
        MenuLabel:
            idx: 0
            idy: -5
            text: '返 回'
            fsize: 3
            on_touch_up:
                self.state = 'normal'
            on_release:
                root.current = 'main'

    Screen:
        name: 'mota'
        Mota:

    Screen:
        name: 'setting-base'

        MenuSetting:
            idx: -15
            idy: 12
            type: 'base'
            root: root

        FloatLayout:
            MenuLabel:
                idx: -10
                idy: 6
                text: '新 手'
                fsize: 4
                group: 'different'
                allow_no_selection: False
                selected: Setting.difficult_type == 'very-easy'
                on_release: Setting.difficult_type = 'very-easy'
            MenuLabel:
                idx: -10
                idy: 2
                text: '容 易'
                fsize: 4
                group: 'different'
                allow_no_selection: False
                selected: Setting.difficult_type == 'easy'
                on_release: Setting.difficult_type = 'easy'
            MenuLabel:
                idx: -10
                idy: -2
                text: '正 常'
                fsize: 4
                group: 'different'
                allow_no_selection: False
                selected: Setting.difficult_type == 'normal'
                on_release: Setting.difficult_type = 'normal'
            MenuLabel:
                idx: -10
                idy: -6
                text: '困 难'
                fsize: 4
                group: 'different'
                allow_no_selection: False
                selected: Setting.difficult_type == 'hard'
                on_release: Setting.difficult_type = 'hard'
            MenuLabel:
                idx: -10
                idy: -10
                text: '噩 梦'
                fsize: 4
                group: 'different'
                allow_no_selection: False
                selected: Setting.difficult_type == 'very-hard'
                on_release: Setting.difficult_type = 'very-hard'

        MenuParameter:
            idx: 0
            idy: 6
            text: '层数'
            attr: 'base'
            min: 2

        MenuParameter:
            idx: 0
            idy: 2
            text: '大小'
            attr: 'size'
            min: 3

        FloatLayout:
            MenuLabel:
                idx: 6
                idy: -2
                text: '血 量'
                fsize: 3
                selected: Setting.show_health
                on_release: Setting.show_health = not Setting.show_health
            MenuLabel:
                idx: 2
                idy: -6
                text: '攻 击'
                fsize: 3
                selected: Setting.show_attack
                on_release: Setting.show_attack = not Setting.show_attack
            MenuLabel:
                idx: 10
                idy: -6
                text: '防 御'
                fsize: 3
                selected: Setting.show_defence
                on_release: Setting.show_defence = not Setting.show_defence
            MenuLabel:
                idx: 6
                idy: -10
                text: '伤 害'
                fsize: 3
                selected: Setting.show_damage
                on_release: Setting.show_damage = not Setting.show_damage

    Screen:
        name: 'setting-operate'

        MenuSetting:
            idx: -15
            idy: 12
            type: 'operate'
            root: root

        MenuLabel:
            idx: 0
            idy: 6
            text: '触 控'
            fsize: 4
        MenuLabel:
            idx: -10
            idy: 2
            text: '触 控'
            fsize: 3
            group: 'touch'
            allow_no_selection: False
            selected: Setting.touch
            on_release: Setting.touch = True
        MenuLabel:
            idx: 10
            idy: 2
            text: '虚 拟'
            fsize: 3
            group: 'touch'
            allow_no_selection: False
            selected: not Setting.touch
            on_release: Setting.touch = False
        MenuLabel:
            idx: 0
            idy: -4
            text: '键 盘'
            fsize: 4
            disabled: True
        MenuLabel:
            idx: -10
            idy: -10
            text: '      W\nA    S    D'
            fsize: 3
            group: 'keyboard'
            allow_no_selection: False
            selected: Setting.keyboard_wasd
            on_release: Setting.keyboard_wasd = True
        MenuLabel:
            idx: 10
            idy: -10
            text: '       ↑\n←   ↓   →'
            fsize: 3
            group: 'keyboard'
            allow_no_selection: False
            selected: not Setting.keyboard_wasd
            on_release: Setting.keyboard_wasd = False

    Screen:
        name: 'setting-sound'

        MenuSetting:
            idx: -15
            idy: 12
            type: 'sound'
            root: root

        MenuLabel:
            idx: 0
            idy: 6
            text: '背 景'
            fsize: 4
            selected: Setting.sound_back
            on_release: Setting.sound_back = not Setting.sound_back
        MenuParameter:
            idx: -6
            idy: 2
            text: '音 量'
            attr: 'sound_back_volume'
            min: 0
            max: 100
        MenuLabel:
            idx: 0
            idy: -4
            text: '音 效'
            fsize: 4
            selected: Setting.sound_effect
            on_release: Setting.sound_effect = not Setting.sound_effect
        MenuParameter:
            idx: -6
            idy: -8
            text: '音 量'
            attr: 'sound_effect_volume'
            min: 0
            max: 100

    Screen:
        name: 'setting-other'

        MenuSetting:
            idx: -15
            idy: 12
            type: 'other'
            root: root

        MenuLabel:
            idx: 0
            idy: 6
            text: ''
            fsize: 3
            disabled: True
        MenuLabel:
            idx: 0
            idy: 2
            text: '制 作:  zx013'
            fsize: 3
            disabled: True
        MenuLabel:
            idx: 0
            idy: -2
            text: '音 乐:  zx013'
            fsize: 3
            disabled: True
        MenuLabel:
            idx: 0
            idy: -6
            text: '美 术:  zx013'
            fsize: 3
            disabled: True
        MenuLabel:
            idx: 0
            idy: -10
            text: '联系及反馈: zxlib@foxmail.com'
            fsize: 2
            disabled: True
